<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Mirio Eggmann">
    <meta name="description" content="Mirio Eggmann&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mask public IP from your Home Server with a OpenVPN VPS"/>
<meta name="twitter:description" content="The right picture shows an example service without a VPS (Virtual Privat Server) in front. It exposes the public IP of your home network to the world.
The left picture shows the example service with a VPS in front. It exposes the IP of your VPS machine fg. an IP of the Google Cloud Platform. The IP of your home network stays hidden.
Setup OpenVPN VPS Instance on GCP Create instance Go to: Compute Engine -&gt; VM instances -&gt; Create Instance"/>

    <meta property="og:title" content="Mask public IP from your Home Server with a OpenVPN VPS" />
<meta property="og:description" content="The right picture shows an example service without a VPS (Virtual Privat Server) in front. It exposes the public IP of your home network to the world.
The left picture shows the example service with a VPS in front. It exposes the IP of your VPS machine fg. an IP of the Google Cloud Platform. The IP of your home network stays hidden.
Setup OpenVPN VPS Instance on GCP Create instance Go to: Compute Engine -&gt; VM instances -&gt; Create Instance" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mirioeggmann.github.io/posts/mask-public-ip-from-your-home-server-with-a-openvpn-vps/" />
<meta property="article:published_time" content="2019-09-28T13:27:10&#43;02:00"/>
<meta property="article:modified_time" content="2019-09-28T13:27:10&#43;02:00"/>


    
      <base href="https://mirioeggmann.github.io/posts/mask-public-ip-from-your-home-server-with-a-openvpn-vps/">
    
    <title>
  Mask public IP from your Home Server with a OpenVPN VPS · 
</title>

    
      <link rel="canonical" href="https://mirioeggmann.github.io/posts/mask-public-ip-from-your-home-server-with-a-openvpn-vps/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://mirioeggmann.github.io/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    
    
    <link rel="icon" type="image/png" href="https://mirioeggmann.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://mirioeggmann.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.55.4" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://mirioeggmann.github.io/">
      
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Mask public IP from your Home Server with a OpenVPN VPS</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2019-09-28T13:27:10&#43;02:00'>
                September 28, 2019
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              3 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://mirioeggmann.github.io/categories/technology/">technology</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://mirioeggmann.github.io/tags/openvpn/">openvpn</a>
      <span class="separator">•</span>
    <a href="https://mirioeggmann.github.io/tags/vps/">vps</a>
      <span class="separator">•</span>
    <a href="https://mirioeggmann.github.io/tags/google-cloud-platform/">google-cloud-platform</a></div>

        </div>
      </header>

      <div>
        

<p><img src="https://mirioeggmann.github.io/images/posts/2/setup.png" alt="setup" /></p>

<p>The right picture shows an example service without a VPS (Virtual Privat Server) in front. It exposes the
public IP of your home network to the world.</p>

<p>The left picture shows the example service with a VPS in front. It exposes the IP of your VPS machine fg. an IP
of the Google Cloud Platform. The IP of your home network stays hidden.</p>

<h2 id="setup-openvpn-vps-instance-on-gcp">Setup OpenVPN VPS Instance on GCP</h2>

<h3 id="create-instance">Create instance</h3>

<p>Go to: Compute Engine -&gt; VM instances -&gt; Create Instance</p>

<ul>
<li>Set your desired name</li>
<li>Change the machine type to <code>f1-micro</code></li>
<li>Configure Boot disk

<ul>
<li>OS image: <code>Debian GNU/Linux 9 (stretch)</code></li>
<li>Boot disk type: <code>Standard persistent disk</code></li>
<li>Size (GB): <code>10</code></li>
</ul></li>
<li>Click <code>Create</code></li>
</ul>

<h3 id="assign-static-ip-address">Assign static IP address</h3>

<p>Go to: VPC Network -&gt; External IP addresses -&gt; RESERVE STATIC IP ADDRESS</p>

<ul>
<li>Set your desired name</li>
<li>Change <code>Attach to</code> to your new OpenVPN instance</li>
<li>IP version: <code>IPv4</code></li>
<li>Click <code>Reserve</code></li>
</ul>

<h3 id="add-firewall-rule-for-openvpn">Add firewall rule for openvpn</h3>

<p>Go to: VPC Network -&gt; Firewall rules -&gt; CREATE FIREWALL RULE</p>

<ul>
<li>Set your desired name</li>
<li>Targets: <code>All instances in the network</code></li>
<li>Source IP ranges: <code>0.0.0.0/0</code></li>
<li>Protocols and ports -&gt; Specified protocols and ports: <code>udp:1194</code></li>
<li>Click <code>Create</code></li>
</ul>

<h3 id="add-firewall-rule-for-http-https">Add firewall rule for http,https</h3>

<p>Go to: VPC Network -&gt; Firewall rules -&gt; CREATE FIREWALL RULE</p>

<ul>
<li>Set your desired name</li>
<li>Targets: <code>All instances in the network</code></li>
<li>Source IP ranges: <code>0.0.0.0/0</code></li>
<li>Protocols and ports -&gt; Specified protocols and ports: <code>tcp:80,443; udp:80,443</code></li>
<li>Click <code>Create</code></li>
</ul>

<h2 id="configure-the-openvpn-vps-instance">Configure the OpenVPN VPS Instance</h2>

<p>Go to: Compute Engine -&gt; VM instances &amp; click on the <code>SSH</code> button of your new instance</p>

<ul>
<li>Update the machine
<code>bash
sudo apt update &amp; sudo apt upgrade -y
</code></li>
<li>Install and setup OpenVPN
<code>bash
wget https://git.io/vpn -O openvpn-install.sh &amp;&amp; sudo bash openvpn-install.sh
</code>

<ul>
<li>For <code>Public IPv4 address / hostname</code> enter the static IP address you defined under
VPC Network -&gt; External IP addresses -&gt; RESERVE STATIC IP ADDRESS</li>
<li>Which protocol do you want for OpenVPN connections?: <code>1) UDP</code></li>
<li>What port do you want OpenVPN listening to?: <code>1194</code></li>
<li>Which DNS do you want to use with the VPN?: <code>3) Google</code></li>
<li>Finally, tell me a name for the client certificate.: You can just let it <code>client</code></li>
</ul></li>
<li>Install and enable UFW firewall
<code>bash
sudo apt install ufw -y
sudo ufw allow ssh &amp;&amp; sudo ufw enable
</code></li>

<li><p>Install and configure fail2ban</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install fail2ban -y
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
<span style="color:#007f7f"># you can make changes in the /etc/fail2ban/jail.local file</span>
<span style="color:#007f7f"># after that, restart fail2ban with</span>
sudo service fail2ban restart</code></pre></div></li>

<li><p>Change <code>DEFAULT_INPUT_POLICY</code> and <code>DEFAULT_FORWARD_POLICY</code> to <code>ACCEPT</code>  in <code>/etc/default/ufw</code> and then save and close the file.</p></li>

<li><p>Uncomment <code>net/ipv4/ip_forward=1</code> in <code>/etc/ufw/sysctl.conf</code></p></li>

<li><p>At the end of line after the line &ldquo;&ldquo;COMMIT&rdquo; add the following in <code>/etc/ufw/before.rules</code> (replace
YOUR_ETH0_IP_ADDRESS with the address you get from <code>ip addr | grep eth0</code> fg. <code>10.172.0.2</code>)</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">*nat
-F
:PREROUTING ACCEPT [0:0]
-A PREROUTING -i eth0 -d YOUR_ETH0_IP_ADDRESS -p tcp -m multiport --dports 23:65535 -j DNAT --to-destination 10.8.0.2
-A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j MASQUERADE
COMMIT</pre></div></li>

<li><p>Reboot the server</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo reboot</code></pre></div></li>
</ul>

<h2 id="configure-the-home-server">Configure the Home Server</h2>

<ul>
<li>Install OpenVPN
<code>bash
sudo apt install openvpn -y
</code></li>
<li>Copy the client config from your OpenVPN VPS which is stored under <code>/root/client.ovpn</code> to your home server</li>
<li>Connect the home server to the OpenVPN VPS (ATTENTION: after you connect you will lose the connection to your home server and it will only be accessible over the
VPN&hellip; so you have to connect to it over the OpenVPN VPS and from there you can open an SSH session with ssh USERNAME@10.8.0.2)
<code>bash
sudo openvpn client.ovpn
</code></li>
</ul>

<h2 id="further-information">Further information</h2>

<p>New the home server should be accessible over your OpenVPN VPS IP. So if you have any Domains that are
linked to your Public Home IP you have to change them to your OpenVPN VPS IP.</p>

<div> Feel free to
    <div style="margin-left:5px;margin-right:5px; display:inline-block;" id="tippin-button" data-dest="mirioeggmann"></div> ;)
    <script src="https://tippin.me/buttons/tip.js" type="text/javascript"></script>
</div>

      </div>

      <footer>
        


        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
      
      [<a href="https://github.com/luizdepra/hugo-coder/tree/"></a>]
    
  </section>
</footer>

    </main>

    

  </body>

</html>
